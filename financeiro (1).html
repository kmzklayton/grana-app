<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grana</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<!-- Firebase -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
import { getFirestore, doc, setDoc, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyBJnFcM06whh1R6rLuKEXRfnC-9-jpTrYc",
  authDomain: "grana-no-app.firebaseapp.com",
  projectId: "grana-no-app",
  storageBucket: "grana-no-app.firebasestorage.app",
  messagingSenderId: "434920953949",
  appId: "1:434920953949:web:33bdedd026aa77ae4b95b4",
  measurementId: "G-E194SFG90G"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Expose to global scope for use in non-module scripts
window._firebaseAuth = auth;
window._firebaseDb = db;
window._GoogleAuthProvider = GoogleAuthProvider;
window._signInWithPopup = signInWithPopup;
window._signOut = signOut;
window._onAuthStateChanged = onAuthStateChanged;
window._firestoreDoc = doc;
window._firestoreSetDoc = setDoc;
window._firestoreGetDoc = getDoc;
window._firestoreOnSnapshot = onSnapshot;

// Listen for auth state
onAuthStateChanged(auth, (user) => {
  if (user) {
    window._currentUser = user;
    showApp(user);
  } else {
    window._currentUser = null;
    showLogin();
  }
});
</script>
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --surface2: #1a1a26;
    --border: #2a2a3a;
    --accent: #c8f55a;
    --accent2: #ff6b6b;
    --accent3: #5af5c8;
    --text: #e8e8f0;
    --muted: #666680;
    --income: #5af5c8;
    --expense: #ff6b6b;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Noise texture overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 1000;
    opacity: 0.4;
  }

  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 24px 40px;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    background: rgba(10,10,15,0.9);
    backdrop-filter: blur(20px);
    z-index: 100;
  }

  .logo {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 1.4rem;
    letter-spacing: -0.02em;
  }

  .logo span { color: var(--accent); }

  .month-selector {
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 16px;
  }

  .month-selector button {
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    font-size: 1rem;
    padding: 0 4px;
    transition: color 0.2s;
  }
  .month-selector button:hover { color: var(--accent); }

  #month-display {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    min-width: 120px;
    text-align: center;
  }

  main {
    max-width: 1300px;
    margin: 0 auto;
    padding: 40px;
  }

  /* Summary cards */
  .summary-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    margin-bottom: 40px;
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px;
    position: relative;
    overflow: hidden;
    transition: transform 0.2s, border-color 0.2s;
  }

  .card:hover {
    transform: translateY(-2px);
    border-color: var(--border);
  }

  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
  }

  .card.balance::before { background: var(--accent); }
  .card.income::before { background: var(--income); }
  .card.expense::before { background: var(--expense); }

  .card-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: var(--muted);
    margin-bottom: 12px;
  }

  .card-value {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 2.2rem;
    letter-spacing: -0.03em;
    line-height: 1;
  }

  .card.balance .card-value { color: var(--accent); }
  .card.income .card-value { color: var(--income); }
  .card.expense .card-value { color: var(--expense); }

  .card.fixed::before { background: #f5c85a; }
  .card.variable::before { background: #a55af5; }
  .card.fixed .card-value { color: #f5c85a; }
  .card.variable .card-value { color: #a55af5; }

  .subtype-toggle {
    display: grid;
    grid-template-columns: 1fr 1fr;
    background: var(--surface2);
    border-radius: 8px;
    padding: 3px;
    margin-bottom: 16px;
    border: 1px solid var(--border);
    display: none;
  }

  .subtype-toggle.visible { display: grid; }

  .subtype-btn {
    padding: 8px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    background: transparent;
    color: var(--muted);
    transition: all 0.2s;
    letter-spacing: 0.05em;
  }

  .subtype-btn.active-fixed {
    background: rgba(245, 200, 90, 0.15);
    color: #f5c85a;
    border: 1px solid rgba(245, 200, 90, 0.3);
  }

  .subtype-btn.active-variable {
    background: rgba(165, 90, 245, 0.15);
    color: #a55af5;
    border: 1px solid rgba(165, 90, 245, 0.3);
  }

  .expense-badge {
    display: inline-block;
    font-size: 0.62rem;
    padding: 2px 7px;
    border-radius: 4px;
    margin-left: 6px;
    vertical-align: middle;
    letter-spacing: 0.08em;
  }

  .badge-fixed {
    background: rgba(245,200,90,0.15);
    color: #f5c85a;
    border: 1px solid rgba(245,200,90,0.25);
  }

  .badge-variable {
    background: rgba(165,90,245,0.15);
    color: #a55af5;
    border: 1px solid rgba(165,90,245,0.25);
  }

  .badge-credit {
    background: rgba(90,143,245,0.15);
    color: #5a8ff5;
    border: 1px solid rgba(90,143,245,0.25);
  }

  .credit-fields {
    display: none;
    background: var(--surface2);
    border: 1px solid rgba(90,143,245,0.25);
    border-radius: 10px;
    padding: 14px;
    margin-bottom: 16px;
    animation: fadeIn 0.2s ease;
  }

  .credit-fields.visible { display: block; }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }

  .credit-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: #5a8ff5;
  }

  .credit-toggle-wrap {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 16px;
  }

  .toggle-switch {
    position: relative;
    width: 38px;
    height: 20px;
    flex-shrink: 0;
  }

  .toggle-switch input { opacity: 0; width: 0; height: 0; }

  .toggle-slider {
    position: absolute;
    inset: 0;
    background: var(--border);
    border-radius: 20px;
    cursor: pointer;
    transition: 0.2s;
  }

  .toggle-slider::before {
    content: '';
    position: absolute;
    width: 14px; height: 14px;
    left: 3px; top: 3px;
    background: var(--muted);
    border-radius: 50%;
    transition: 0.2s;
  }

  .toggle-switch input:checked + .toggle-slider { background: rgba(90,143,245,0.3); border: 1px solid rgba(90,143,245,0.5); }
  .toggle-switch input:checked + .toggle-slider::before { transform: translateX(18px); background: #5a8ff5; }

  .toggle-label { font-size: 0.8rem; color: var(--muted); }

  .card-sub {
    font-size: 0.75rem;
    color: var(--muted);
    margin-top: 8px;
  }

  /* Content grid */
  .content-grid {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 24px;
    margin-bottom: 32px;
  }

  /* Form */
  .panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px;
  }

  .panel-title {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--muted);
    margin-bottom: 24px;
  }

  .type-toggle {
    display: grid;
    grid-template-columns: 1fr 1fr;
    background: var(--surface2);
    border-radius: 10px;
    padding: 4px;
    margin-bottom: 20px;
    border: 1px solid var(--border);
  }

  .type-btn {
    padding: 10px;
    border: none;
    border-radius: 7px;
    cursor: pointer;
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    font-weight: 500;
    background: transparent;
    color: var(--muted);
    transition: all 0.2s;
    letter-spacing: 0.05em;
  }

  .type-btn.active-income {
    background: rgba(90, 245, 200, 0.15);
    color: var(--income);
    border: 1px solid rgba(90, 245, 200, 0.3);
  }

  .type-btn.active-expense {
    background: rgba(255, 107, 107, 0.15);
    color: var(--expense);
    border: 1px solid rgba(255, 107, 107, 0.3);
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-group label {
    display: block;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--muted);
    margin-bottom: 8px;
  }

  .form-group input, .form-group select {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 14px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 0.85rem;
    transition: border-color 0.2s;
    outline: none;
  }

  .form-group input:focus, .form-group select:focus {
    border-color: var(--accent);
  }

  .form-group select option { background: var(--surface2); }

  .submit-btn {
    width: 100%;
    padding: 14px;
    background: var(--accent);
    color: #0a0a0f;
    border: none;
    border-radius: 10px;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 0.9rem;
    letter-spacing: 0.05em;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 4px;
  }

  .submit-btn:hover {
    background: #d4ff6a;
    transform: translateY(-1px);
  }

  /* Chart panel */
  .chart-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px;
    margin-bottom: 24px;
  }

  .chart-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 24px;
  }

  .chart-tab {
    padding: 7px 16px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.05em;
  }

  .chart-tab.active {
    background: rgba(200, 245, 90, 0.12);
    border-color: var(--accent);
    color: var(--accent);
  }

  .chart-container { height: 280px; position: relative; }

  /* Categories */
  .categories-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 10px;
    margin-top: 0;
  }

  .cat-item {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }

  .cat-item:hover { border-color: var(--accent); transform: translateY(-1px); }
  .cat-item.active { border-color: var(--accent); background: rgba(200,245,90,0.08); }

  .cat-icon { font-size: 1.4rem; margin-bottom: 6px; }
  .cat-name { font-size: 0.7rem; color: var(--muted); letter-spacing: 0.08em; }
  .cat-amount {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 0.85rem;
    margin-top: 4px;
    color: var(--text);
  }

  /* Transactions */
  .transactions-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
  }

  .trans-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 24px 28px;
    border-bottom: 1px solid var(--border);
  }

  .trans-header-title {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--muted);
  }

  .filter-btns { display: flex; gap: 6px; }

  .filter-btn {
    padding: 5px 12px;
    border-radius: 5px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    cursor: pointer;
    transition: all 0.15s;
  }

  .filter-btn.active { border-color: var(--accent); color: var(--accent); }

  #transactions-list { padding: 8px 0; max-height: 400px; overflow-y: auto; }
  #transactions-list::-webkit-scrollbar { width: 4px; }
  #transactions-list::-webkit-scrollbar-track { background: transparent; }
  #transactions-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .trans-item {
    display: flex;
    align-items: center;
    padding: 14px 28px;
    gap: 16px;
    border-bottom: 1px solid rgba(42,42,58,0.5);
    transition: background 0.15s;
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateX(-10px); }
    to { opacity: 1; transform: translateX(0); }
  }

  .trans-item:last-child { border-bottom: none; }
  .trans-item:hover { background: rgba(255,255,255,0.02); }

  .trans-icon {
    width: 40px; height: 40px;
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.1rem;
    flex-shrink: 0;
  }

  .trans-icon.income-icon { background: rgba(90,245,200,0.12); }
  .trans-icon.expense-icon { background: rgba(255,107,107,0.12); }

  .trans-info { flex: 1; min-width: 0; }
  .trans-desc {
    font-size: 0.85rem;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .trans-meta { font-size: 0.7rem; color: var(--muted); margin-top: 2px; }

  .trans-amount {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 0.95rem;
    flex-shrink: 0;
  }

  .trans-amount.income { color: var(--income); }
  .trans-amount.expense { color: var(--expense); }

  .trans-delete {
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    font-size: 0.9rem;
    opacity: 0;
    transition: opacity 0.15s, color 0.15s;
    padding: 4px;
  }

  .trans-item:hover .trans-delete { opacity: 1; }
  .trans-delete:hover { color: var(--expense); }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted);
  }

  .empty-state .empty-icon { font-size: 2.5rem; margin-bottom: 12px; opacity: 0.4; }
  .empty-state p { font-size: 0.8rem; letter-spacing: 0.05em; }

  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

  /* ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  #login-screen {
    display: none;
    position: fixed;
    inset: 0;
    background: var(--bg);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    flex-direction: column;
  }

  #login-screen.visible { display: flex; }

  .login-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 52px 48px;
    width: 100%;
    max-width: 420px;
    text-align: center;
    position: relative;
    overflow: hidden;
  }

  .login-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent), var(--income), var(--accent));
  }

  .login-logo {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 3rem;
    letter-spacing: -0.04em;
    margin-bottom: 8px;
  }

  .login-logo span { color: var(--accent); }

  .login-tagline {
    font-size: 0.78rem;
    color: var(--muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 48px;
  }

  .login-divider {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 28px 0;
    color: var(--muted);
    font-size: 0.7rem;
    letter-spacing: 0.1em;
  }

  .login-divider::before,
  .login-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .btn-google {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 14px 20px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.03em;
  }

  .btn-google:hover {
    border-color: var(--accent);
    background: rgba(200,245,90,0.06);
    transform: translateY(-1px);
  }

  .btn-google svg { width: 20px; height: 20px; flex-shrink: 0; }

  .login-footer {
    margin-top: 36px;
    font-size: 0.68rem;
    color: var(--muted);
    line-height: 1.6;
    opacity: 0.6;
  }

  .login-loading {
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 16px;
    margin-top: 24px;
  }

  .login-loading.visible { display: flex; }

  .spin {
    width: 28px; height: 28px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .login-loading p { font-size: 0.75rem; color: var(--muted); }

  /* User info in header */
  .user-info {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .user-avatar {
    width: 32px; height: 32px;
    border-radius: 50%;
    border: 2px solid var(--border);
    object-fit: cover;
  }

  .user-name {
    font-size: 0.75rem;
    color: var(--muted);
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .btn-logout {
    padding: 6px 12px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-logout:hover { border-color: var(--expense); color: var(--expense); }

  /* App hidden until logged in */
  #app { display: none; }
  #app.visible { display: block; }
  .voice-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 18px;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.78rem;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.05em;
  }

  .voice-btn:hover { border-color: var(--accent); color: var(--accent); }

  .voice-btn.recording {
    border-color: #ff6b6b;
    color: #ff6b6b;
    background: rgba(255,107,107,0.08);
    animation: pulseBorder 1.2s ease-in-out infinite;
  }

  @keyframes pulseBorder {
    0%, 100% { box-shadow: 0 0 0 0 rgba(255,107,107,0.3); }
    50% { box-shadow: 0 0 0 6px rgba(255,107,107,0); }
  }

  .mic-icon { font-size: 1rem; }
  .mic-icon.recording { animation: micPulse 0.6s ease-in-out infinite alternate; }
  @keyframes micPulse { from { transform: scale(1); } to { transform: scale(1.3); } }

  /* Voice feedback panel */
  .voice-panel {
    position: fixed;
    bottom: 32px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px 28px;
    min-width: 360px;
    max-width: 520px;
    z-index: 500;
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  }

  .voice-panel.visible {
    opacity: 1;
    pointer-events: all;
    transform: translateX(-50%) translateY(0);
  }

  .voice-panel-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
  }

  .voice-wave {
    display: flex;
    align-items: center;
    gap: 3px;
    height: 20px;
  }

  .voice-wave span {
    display: block;
    width: 3px;
    background: #ff6b6b;
    border-radius: 2px;
    animation: waveBar 0.8s ease-in-out infinite;
  }

  .voice-wave span:nth-child(1) { animation-delay: 0s; }
  .voice-wave span:nth-child(2) { animation-delay: 0.1s; }
  .voice-wave span:nth-child(3) { animation-delay: 0.2s; }
  .voice-wave span:nth-child(4) { animation-delay: 0.3s; }
  .voice-wave span:nth-child(5) { animation-delay: 0.4s; }

  @keyframes waveBar {
    0%, 100% { height: 4px; }
    50% { height: 18px; }
  }

  .voice-wave.idle span { animation: none; height: 4px; background: var(--muted); }
  .voice-wave.success span { background: var(--income); animation: none; height: 14px; }
  .voice-wave.error span { background: var(--expense); animation: none; height: 4px; }

  .voice-status {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 0.85rem;
    color: var(--text);
  }

  .voice-transcript {
    font-size: 0.8rem;
    color: var(--muted);
    min-height: 20px;
    font-style: italic;
    margin-bottom: 10px;
    line-height: 1.5;
  }

  .voice-result {
    font-size: 0.78rem;
    padding: 10px 12px;
    border-radius: 8px;
    display: none;
    line-height: 1.6;
  }

  .voice-result.success {
    background: rgba(90,245,200,0.08);
    border: 1px solid rgba(90,245,200,0.2);
    color: var(--income);
    display: block;
  }

  .voice-result.error {
    background: rgba(255,107,107,0.08);
    border: 1px solid rgba(255,107,107,0.2);
    color: var(--expense);
    display: block;
  }

  .voice-hint {
    font-size: 0.68rem;
    color: var(--muted);
    margin-top: 10px;
    opacity: 0.7;
    letter-spacing: 0.05em;
  }

  @media (max-width: 1024px) {
    .content-grid { grid-template-columns: 1fr; }
    .summary-grid { grid-template-columns: 1fr; }
    main { padding: 20px; }
    header { padding: 16px 20px; }
  }
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">grana<span>.</span></div>
    <div class="login-tagline">Controle financeiro pessoal</div>

    <button class="btn-google" onclick="loginWithGoogle()">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/>
        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
      </svg>
      Entrar com Google
    </button>

    <div class="login-loading" id="login-loading">
      <div class="spin"></div>
      <p>Entrando‚Ä¶</p>
    </div>

    <div class="login-footer">
      Seus dados ficam salvos na nuvem e<br>sincronizados em qualquer dispositivo.
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="app">
<header>
  <div class="logo">grana<span>.</span></div>
  <div style="display:flex;align-items:center;gap:12px">
    <div class="user-info">
      <img class="user-avatar" id="user-avatar" src="" alt="" style="display:none">
      <span class="user-name" id="user-name"></span>
      <button class="btn-logout" onclick="handleLogout()">Sair</button>
    </div>
    <button class="voice-btn" id="voice-btn" onclick="toggleVoice()">
      <span class="mic-icon" id="mic-icon">üéôÔ∏è</span>
      <span id="voice-btn-label">Comando de voz</span>
    </button>
    <div class="month-selector">
      <button onclick="changeMonth(-1)">‚óÄ</button>
      <div id="month-display"></div>
      <button onclick="changeMonth(1)">‚ñ∂</button>
    </div>
  </div>
</header>

<main>
  <!-- Summary Cards -->
  <div class="summary-grid">
    <div class="card balance">
      <div class="card-label">Saldo do M√™s</div>
      <div class="card-value" id="balance">R$ 0,00</div>
      <div class="card-sub" id="balance-sub">Receitas ‚àí Despesas</div>
    </div>
    <div class="card income">
      <div class="card-label">Total Receitas</div>
      <div class="card-value" id="total-income">R$ 0,00</div>
      <div class="card-sub" id="income-count">0 lan√ßamentos</div>
    </div>
    <div class="card fixed">
      <div class="card-label">Despesas Fixas</div>
      <div class="card-value" id="total-fixed">R$ 0,00</div>
      <div class="card-sub" id="fixed-count">0 lan√ßamentos</div>
    </div>
    <div class="card variable">
      <div class="card-label">Despesas Vari√°veis</div>
      <div class="card-value" id="total-variable">R$ 0,00</div>
      <div class="card-sub" id="variable-count">0 lan√ßamentos</div>
    </div>
  </div>

  <!-- Charts -->
  <div class="chart-panel">
    <div class="chart-tabs">
      <button class="chart-tab active" onclick="switchChart('line', this)">Evolu√ß√£o</button>
      <button class="chart-tab" onclick="switchChart('doughnut', this)">Categorias</button>
      <button class="chart-tab" onclick="switchChart('bar', this)">Comparativo</button>
    </div>
    <div class="chart-container">
      <canvas id="main-chart"></canvas>
    </div>
  </div>

  <div class="content-grid">
    <!-- Add Transaction Form -->
    <div>
      <div class="panel">
        <div class="panel-title">Novo Lan√ßamento</div>

        <div class="type-toggle">
          <button class="type-btn active-income" id="btn-income" onclick="setType('income')">+ Receita</button>
          <button class="type-btn" id="btn-expense" onclick="setType('expense')">‚àí Despesa</button>
        </div>

        <!-- Subtype for expenses -->
        <div class="subtype-toggle" id="subtype-toggle">
          <button class="subtype-btn active-fixed" id="btn-fixed" onclick="setSubtype('fixed')">üìå Fixa</button>
          <button class="subtype-btn" id="btn-variable" onclick="setSubtype('variable')">üîÄ Vari√°vel</button>
        </div>

        <!-- Credit card fields (only for variable expenses) -->
        <div class="credit-fields" id="credit-fields">
          <div class="credit-toggle-wrap">
            <label class="toggle-switch">
              <input type="checkbox" id="is-credit" onchange="toggleCreditDetails()">
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">üí≥ Pago no cart√£o de cr√©dito</span>
          </div>
          <div id="credit-details" style="display:none">
            <div class="two-col">
              <div class="form-group" style="margin-bottom:0">
                <label>Cart√£o</label>
                <input type="text" id="card-name" placeholder="Ex: Nubank, Inter‚Ä¶" />
              </div>
              <div class="form-group" style="margin-bottom:0">
                <label>Parcelas</label>
                <select id="installments" onchange="updateInstallmentPreview()">
                  <option value="1">1√ó (√† vista)</option>
                  <option value="2">2√ó</option>
                  <option value="3">3√ó</option>
                  <option value="4">4√ó</option>
                  <option value="5">5√ó</option>
                  <option value="6">6√ó</option>
                  <option value="7">7√ó</option>
                  <option value="8">8√ó</option>
                  <option value="9">9√ó</option>
                  <option value="10">10√ó</option>
                  <option value="11">11√ó</option>
                  <option value="12">12√ó</option>
                  <option value="18">18√ó</option>
                  <option value="24">24√ó</option>
                </select>
              </div>
            </div>
            <div id="installment-preview" style="display:none;margin-top:10px;font-size:0.8rem;color:#5a8ff5;padding:8px 10px;background:rgba(90,143,245,0.08);border-radius:6px;border:1px solid rgba(90,143,245,0.2);"></div>
          </div>
        </div>

        <div class="two-col">
          <div class="form-group">
            <label>Descri√ß√£o</label>
            <input type="text" id="desc" placeholder="Ex: Sal√°rio" />
          </div>
          <div class="form-group">
            <label id="amount-label">Valor (R$)</label>
            <input type="number" id="amount" placeholder="0,00" step="0.01" min="0" oninput="updateInstallmentPreview()" />
          </div>
        </div>

        <div class="two-col">
          <div class="form-group">
            <label>Categoria</label>
            <select id="category">
              <option value="">Selecionar...</option>
            </select>
          </div>
          <div class="form-group">
            <label>Data</label>
            <input type="date" id="date" />
          </div>
        </div>

        <button class="submit-btn" onclick="addTransaction()">ADICIONAR LAN√áAMENTO</button>
      </div>

      <!-- Category summary -->
      <div class="panel" style="margin-top:20px">
        <div class="panel-title">Gastos por Categoria</div>
        <div class="categories-grid" id="cat-grid"></div>
      </div>
    </div>

    <!-- Transactions List -->
    <div class="transactions-panel">
      <div class="trans-header">
        <div class="trans-header-title">Lan√ßamentos</div>
        <div class="filter-btns">
          <button class="filter-btn active" onclick="setFilter('all', this)">Todos</button>
          <button class="filter-btn" onclick="setFilter('income', this)">Receitas</button>
          <button class="filter-btn" onclick="setFilter('fixed', this)">Fixas</button>
          <button class="filter-btn" onclick="setFilter('variable', this)">Vari√°veis</button>
        </div>
      </div>
      <div id="transactions-list"></div>
    </div>
  </div>
</main>

<!-- Voice feedback panel -->
<div class="voice-panel" id="voice-panel">
  <div class="voice-panel-header">
    <div class="voice-wave" id="voice-wave">
      <span></span><span></span><span></span><span></span><span></span>
    </div>
    <div class="voice-status" id="voice-status">Ouvindo‚Ä¶</div>
  </div>
  <div class="voice-transcript" id="voice-transcript">Fale seu comando‚Ä¶</div>
  <div class="voice-result" id="voice-result"></div>
  <div class="voice-hint" id="voice-hint">Ex: "gastei 50 reais no almo√ßo" ¬∑ "recebi 3000 de sal√°rio"</div>
</div>

</div><!-- end #app -->

<script>
  // ‚îÄ‚îÄ AUTH & FIRESTORE HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function showLogin() {
    document.getElementById('login-screen').classList.add('visible');
    document.getElementById('app').classList.remove('visible');
  }

  function showApp(user) {
    document.getElementById('login-screen').classList.remove('visible');
    document.getElementById('app').classList.add('visible');
    // Show user info
    const avatar = document.getElementById('user-avatar');
    if (user.photoURL) { avatar.src = user.photoURL; avatar.style.display = 'block'; }
    document.getElementById('user-name').textContent = user.displayName || user.email;
    // Load data from Firestore
    loadFromFirestore(user.uid);
  }

  function loginWithGoogle() {
    document.getElementById('login-loading').classList.add('visible');
    const provider = new window._GoogleAuthProvider();
    window._signInWithPopup(window._firebaseAuth, provider)
      .catch(err => {
        document.getElementById('login-loading').classList.remove('visible');
        alert('Erro ao entrar: ' + err.message);
      });
  }

  function handleLogout() {
    window._signOut(window._firebaseAuth).then(() => {
      transactions = [];
      showLogin();
    });
  }

  async function saveToFirestore() {
    const user = window._currentUser;
    if (!user) return;
    try {
      const ref = window._firestoreDoc(window._firebaseDb, 'users', user.uid);
      await window._firestoreSetDoc(ref, { transactions: JSON.stringify(transactions) });
    } catch(e) { console.error('Erro ao salvar:', e); }
  }

  function loadFromFirestore(uid) {
    const ref = window._firestoreDoc(window._firebaseDb, 'users', uid);
    window._firestoreOnSnapshot(ref, (snap) => {
      if (snap.exists()) {
        try { transactions = JSON.parse(snap.data().transactions || '[]'); }
        catch(e) { transactions = []; }
      } else { transactions = []; }
      refresh();
    });
  }

  // Data
  const CATEGORIES = {
    income: [
      { id: 'salario', name: 'Sal√°rio', icon: 'üíº' },
      { id: 'freelance', name: 'Freelance', icon: 'üíª' },
      { id: 'investimento', name: 'Investimento', icon: 'üìà' },
      { id: 'outros_r', name: 'Outros', icon: 'üí∞' },
    ],
    expense: [
      { id: 'moradia', name: 'Moradia', icon: 'üè†' },
      { id: 'alimentacao', name: 'Alimenta√ß√£o', icon: 'üçΩÔ∏è' },
      { id: 'transporte', name: 'Transporte', icon: 'üöó' },
      { id: 'saude', name: 'Sa√∫de', icon: 'üè•' },
      { id: 'lazer', name: 'Lazer', icon: 'üé¨' },
      { id: 'educacao', name: 'Educa√ß√£o', icon: 'üìö' },
      { id: 'compras', name: 'Compras', icon: 'üõçÔ∏è' },
      { id: 'outros_d', name: 'Outros', icon: 'üì¶' },
    ]
  };

  let transactions = [];
  let currentType = 'income';
  let currentSubtype = 'fixed'; // 'fixed' or 'variable', only used when type=expense
  let currentFilter = 'all';
  let currentChart = 'line';
  let chartInstance = null;
  let currentDate = new Date();

  // Month nav
  const MONTHS = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];

  function updateMonthDisplay() {
    document.getElementById('month-display').textContent =
      `${MONTHS[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
    refresh();
  }

  function changeMonth(dir) {
    currentDate.setMonth(currentDate.getMonth() + dir);
    updateMonthDisplay();
  }

  // Type toggle
  function setType(type) {
    currentType = type;
    document.getElementById('btn-income').className = 'type-btn' + (type === 'income' ? ' active-income' : '');
    document.getElementById('btn-expense').className = 'type-btn' + (type === 'expense' ? ' active-expense' : '');
    const st = document.getElementById('subtype-toggle');
    if (type === 'expense') { st.classList.add('visible'); } else { st.classList.remove('visible'); }
    if (type !== 'expense' || currentSubtype !== 'variable') {
      document.getElementById('credit-fields').classList.remove('visible');
    } else {
      document.getElementById('credit-fields').classList.add('visible');
    }
    updateCategorySelect();
  }

  function setSubtype(subtype) {
    currentSubtype = subtype;
    document.getElementById('btn-fixed').className = 'subtype-btn' + (subtype === 'fixed' ? ' active-fixed' : '');
    document.getElementById('btn-variable').className = 'subtype-btn' + (subtype === 'variable' ? ' active-variable' : '');
    const cf = document.getElementById('credit-fields');
    if (subtype === 'variable') { cf.classList.add('visible'); } else {
      cf.classList.remove('visible');
      document.getElementById('is-credit').checked = false;
      document.getElementById('credit-details').style.display = 'none';
    }
  }

  function toggleCreditDetails() {
    const checked = document.getElementById('is-credit').checked;
    document.getElementById('credit-details').style.display = checked ? 'block' : 'none';
    document.getElementById('amount-label').textContent = checked ? 'Valor Total (R$)' : 'Valor (R$)';
    updateInstallmentPreview();
  }

  function updateInstallmentPreview() {
    const checked = document.getElementById('is-credit').checked;
    const preview = document.getElementById('installment-preview');
    if (!checked || !preview) return;
    const total = parseFloat(document.getElementById('amount').value) || 0;
    const inst = parseInt(document.getElementById('installments').value) || 1;
    if (total > 0 && inst > 1) {
      preview.textContent = `‚Üí ${inst}√ó de ${fmt(total / inst)}/m√™s`;
      preview.style.display = 'block';
    } else {
      preview.style.display = 'none';
    }
  }

  function updateCategorySelect() {
    const sel = document.getElementById('category');
    sel.innerHTML = '<option value="">Selecionar...</option>';
    CATEGORIES[currentType].forEach(c => {
      sel.innerHTML += `<option value="${c.id}">${c.icon} ${c.name}</option>`;
    });
  }

  // Add transaction
  function addTransaction() {
    const desc = document.getElementById('desc').value.trim();
    const totalAmount = parseFloat(document.getElementById('amount').value);
    const category = document.getElementById('category').value;
    const date = document.getElementById('date').value;

    if (!desc || !totalAmount || totalAmount <= 0 || !category || !date) {
      alert('Por favor, preencha todos os campos.');
      return;
    }

    const isCredit = currentType === 'expense' && currentSubtype === 'variable' && document.getElementById('is-credit').checked;
    const installments = isCredit ? parseInt(document.getElementById('installments').value) : null;
    const cardName = isCredit ? document.getElementById('card-name').value.trim() : null;

    // When credit card: amount stored = parcela mensal; totalAmount = valor total da compra
    const amount = isCredit && installments > 1 ? totalAmount / installments : totalAmount;

    const t = {
      id: Date.now(),
      type: currentType,
      subtype: currentType === 'expense' ? currentSubtype : null,
      isCredit,
      installments,
      cardName,
      totalAmount: isCredit ? totalAmount : null,
      amount, // this is the monthly value used in all calculations
      category, date
    };

    t.desc = desc;
    transactions.unshift(t);
    save();
    refresh();

    document.getElementById('desc').value = '';
    document.getElementById('amount').value = '';
    document.getElementById('category').value = '';
    document.getElementById('is-credit').checked = false;
    document.getElementById('credit-details').style.display = 'none';
    document.getElementById('card-name').value = '';
    document.getElementById('installments').value = '1';
    document.getElementById('amount-label').textContent = 'Valor (R$)';
    const preview = document.getElementById('installment-preview');
    if (preview) preview.style.display = 'none';
  }

  function deleteTransaction(id) {
    transactions = transactions.filter(t => t.id !== id);
    save();
    refresh();
  }

  function save() {
    saveToFirestore();
  }

  function getTransactionsForMonth(m, y) {
    const result = [];
    transactions.forEach(t => {
      const d = new Date(t.date + 'T00:00:00');
      const originMonth = d.getMonth();
      const originYear = d.getFullYear();

      if (t.isCredit && t.installments > 1) {
        const monthsDiff = (y - originYear) * 12 + (m - originMonth);
        if (monthsDiff >= 0 && monthsDiff < t.installments) {
          result.push({ ...t, _installmentIndex: monthsDiff + 1 });
        }
      } else {
        if (originMonth === m && originYear === y) {
          result.push(t);
        }
      }
    });
    return result;
  }

  function getMonthTransactions() {
    return getTransactionsForMonth(currentDate.getMonth(), currentDate.getFullYear());
  }

  function fmt(n) {
    return 'R$ ' + n.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
  }

  function getCategoryInfo(catId) {
    const all = [...CATEGORIES.income, ...CATEGORIES.expense];
    return all.find(c => c.id === catId) || { name: catId, icon: 'üìå' };
  }

  // Filter
  function setFilter(f, btn) {
    currentFilter = f;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderTransactions();
  }

  function refresh() {
    const mt = getMonthTransactions();
    const income = mt.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
    const fixed = mt.filter(t => t.type === 'expense' && t.subtype === 'fixed').reduce((s, t) => s + t.amount, 0);
    const variable = mt.filter(t => t.type === 'expense' && (t.subtype === 'variable' || (t.type === 'expense' && !t.subtype))).reduce((s, t) => s + t.amount, 0);
    const expense = fixed + variable;
    const balance = income - expense;

    document.getElementById('balance').textContent = fmt(balance);
    document.getElementById('total-income').textContent = fmt(income);
    document.getElementById('total-fixed').textContent = fmt(fixed);
    document.getElementById('total-variable').textContent = fmt(variable);
    document.getElementById('income-count').textContent = mt.filter(t=>t.type==='income').length + ' lan√ßamentos';
    document.getElementById('fixed-count').textContent = mt.filter(t=>t.type==='expense'&&t.subtype==='fixed').length + ' lan√ßamentos';
    document.getElementById('variable-count').textContent = mt.filter(t=>t.type==='expense'&&t.subtype!=='fixed').length + ' lan√ßamentos';
    document.getElementById('balance-sub').textContent = balance >= 0 ? '‚úì No positivo' : '‚ö† No negativo';

    renderTransactions();
    renderCategories(mt);
    renderChart();
  }

  function renderTransactions() {
    const mt = getMonthTransactions();
    const list = document.getElementById('transactions-list');
    let filtered;
    if (currentFilter === 'all') filtered = mt;
    else if (currentFilter === 'income') filtered = mt.filter(t => t.type === 'income');
    else if (currentFilter === 'fixed') filtered = mt.filter(t => t.type === 'expense' && t.subtype === 'fixed');
    else if (currentFilter === 'variable') filtered = mt.filter(t => t.type === 'expense' && t.subtype !== 'fixed');
    else filtered = mt;

    if (filtered.length === 0) {
      list.innerHTML = `<div class="empty-state"><div class="empty-icon">üì≠</div><p>NENHUM LAN√áAMENTO</p></div>`;
      return;
    }

    list.innerHTML = filtered.map(t => {
      const cat = getCategoryInfo(t.category);
      const d = new Date(t.date + 'T00:00:00');
      const dateStr = d.toLocaleDateString('pt-BR', {day:'2-digit', month:'short'});
      let badge = '';
      if (t.type === 'expense') {
        if (t.subtype === 'fixed') {
          badge = `<span class="expense-badge badge-fixed">FIXA</span>`;
        } else {
          badge = `<span class="expense-badge badge-variable">VARI√ÅVEL</span>`;
          if (t.isCredit) {
            const inst = t.installments > 1 ? `${t.installments}√ó` : '1√ó';
            const cardLabel = t.cardName ? ` ${t.cardName}` : '';
            badge += `<span class="expense-badge badge-credit">üí≥${cardLabel} ${inst}</span>`;
          }
        }
      }
      // For credit purchases: show installment progress in meta line
      const creditMeta = t.isCredit && t.installments > 1
        ? ` ¬∑ Parcela ${t._installmentIndex} de ${t.installments} ¬∑ Total: ${fmt(t.totalAmount)}`
        : '';
      return `
        <div class="trans-item">
          <div class="trans-icon ${t.type}-icon">${cat.icon}</div>
          <div class="trans-info">
            <div class="trans-desc">${t.desc}${badge}</div>
            <div class="trans-meta">${cat.name} ¬∑ ${dateStr}${creditMeta}</div>
          </div>
          <div class="trans-amount ${t.type}">${t.type === 'income' ? '+' : '‚àí'} ${fmt(t.amount)}</div>
          <button class="trans-delete" onclick="deleteTransaction(${t.id})">‚úï</button>
        </div>
      `;
    }).join('');
  }

  function renderCategories(mt) {
    const expenses = mt.filter(t => t.type === 'expense');
    const fixedTotals = {}, varTotals = {};
    expenses.forEach(t => {
      if (t.subtype === 'fixed') fixedTotals[t.category] = (fixedTotals[t.category] || 0) + t.amount;
      else varTotals[t.category] = (varTotals[t.category] || 0) + t.amount;
    });

    const grid = document.getElementById('cat-grid');

    if (expenses.length === 0) {
      grid.innerHTML = '<div style="color:var(--muted);font-size:0.75rem;grid-column:1/-1;text-align:center;padding:20px;">Nenhuma despesa no m√™s</div>';
      return;
    }

    let html = '';

    if (Object.keys(fixedTotals).length > 0) {
      html += `<div style="grid-column:1/-1;font-size:0.7rem;text-transform:uppercase;letter-spacing:0.12em;color:#f5c85a;margin-bottom:4px;margin-top:4px;">üìå Fixas</div>`;
      html += Object.entries(fixedTotals).sort((a,b)=>b[1]-a[1]).map(([id, total]) => {
        const cat = getCategoryInfo(id);
        return `<div class="cat-item" style="border-color:rgba(245,200,90,0.2)">
          <div class="cat-icon">${cat.icon}</div>
          <div class="cat-name">${cat.name.toUpperCase()}</div>
          <div class="cat-amount" style="color:#f5c85a">${fmt(total)}</div>
        </div>`;
      }).join('');
    }

    if (Object.keys(varTotals).length > 0) {
      html += `<div style="grid-column:1/-1;font-size:0.7rem;text-transform:uppercase;letter-spacing:0.12em;color:#a55af5;margin-bottom:4px;margin-top:12px;">üîÄ Vari√°veis</div>`;
      html += Object.entries(varTotals).sort((a,b)=>b[1]-a[1]).map(([id, total]) => {
        const cat = getCategoryInfo(id);
        return `<div class="cat-item" style="border-color:rgba(165,90,245,0.2)">
          <div class="cat-icon">${cat.icon}</div>
          <div class="cat-name">${cat.name.toUpperCase()}</div>
          <div class="cat-amount" style="color:#a55af5">${fmt(total)}</div>
        </div>`;
      }).join('');
    }

    grid.innerHTML = html;
  }

  function switchChart(type, btn) {
    currentChart = type;
    document.querySelectorAll('.chart-tab').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderChart();
  }

  function renderChart() {
    if (chartInstance) { chartInstance.destroy(); chartInstance = null; }

    const ctx = document.getElementById('main-chart').getContext('2d');
    const mt = getMonthTransactions();

    if (currentChart === 'line') {
      // Daily evolution
      const days = {};
      mt.forEach(t => {
        if (!days[t.date]) days[t.date] = { income: 0, expense: 0 };
        days[t.date][t.type] += t.amount;
      });

      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const labels = [], incomeData = [], expenseData = [];

      let cumInc = 0, cumExp = 0;
      for (let i = 1; i <= daysInMonth; i++) {
        const key = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
        cumInc += (days[key]?.income || 0);
        cumExp += (days[key]?.expense || 0);
        labels.push(i);
        incomeData.push(cumInc);
        expenseData.push(cumExp);
      }

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'Receitas', data: incomeData, borderColor: '#5af5c8', backgroundColor: 'rgba(90,245,200,0.08)', tension: 0.4, fill: true, pointRadius: 0, borderWidth: 2 },
            { label: 'Despesas', data: expenseData, borderColor: '#ff6b6b', backgroundColor: 'rgba(255,107,107,0.08)', tension: 0.4, fill: true, pointRadius: 0, borderWidth: 2 }
          ]
        },
        options: getChartOptions('Dia')
      });

    } else if (currentChart === 'doughnut') {
      const expenses = mt.filter(t => t.type === 'expense');
      const totals = {};
      expenses.forEach(t => { totals[t.category] = (totals[t.category] || 0) + t.amount; });

      const entries = Object.entries(totals);
      const colors = ['#c8f55a','#5af5c8','#ff6b6b','#f5c85a','#a55af5','#5a8ff5','#f55ab4','#f5955a'];

      chartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: entries.map(([id]) => getCategoryInfo(id).name),
          datasets: [{ data: entries.map(([,v]) => v), backgroundColor: colors, borderWidth: 0, hoverOffset: 8 }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: {
            legend: { position: 'right', labels: { color: '#888', font: { family: 'DM Mono', size: 11 }, padding: 12 } },
            tooltip: { callbacks: { label: ctx => ` ${fmt(ctx.parsed)}` }, backgroundColor: '#1a1a26', bodyColor: '#e8e8f0', padding: 10, bodyFont: { family: 'DM Mono' } }
          },
          cutout: '65%'
        }
      });

    } else if (currentChart === 'bar') {
      // Last 6 months: income, fixed expenses, variable expenses ‚Äî using installment-aware logic
      const labels = [], incomeData = [], fixedData = [], varData = [];
      for (let i = 5; i >= 0; i--) {
        const d = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
        labels.push(MONTHS[d.getMonth()].substring(0,3));
        const key_m = d.getMonth(), key_y = d.getFullYear();
        const mts = getTransactionsForMonth(key_m, key_y);
        incomeData.push(mts.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0));
        fixedData.push(mts.filter(t=>t.type==='expense'&&t.subtype==='fixed').reduce((s,t)=>s+t.amount,0));
        varData.push(mts.filter(t=>t.type==='expense'&&t.subtype!=='fixed').reduce((s,t)=>s+t.amount,0));
      }

      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Receitas', data: incomeData, backgroundColor: 'rgba(90,245,200,0.7)', borderRadius: 6 },
            { label: 'Fixas', data: fixedData, backgroundColor: 'rgba(245,200,90,0.7)', borderRadius: 6 },
            { label: 'Vari√°veis', data: varData, backgroundColor: 'rgba(165,90,245,0.7)', borderRadius: 6 }
          ]
        },
        options: getChartOptions('M√™s')
      });
    }
  }

  function getChartOptions(xLabel) {
    return {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { labels: { color: '#666680', font: { family: 'DM Mono', size: 11 }, padding: 16 } },
        tooltip: { backgroundColor: '#1a1a26', titleColor: '#888', bodyColor: '#e8e8f0', padding: 12, bodyFont: { family: 'DM Mono' }, callbacks: { label: ctx => ` ${fmt(ctx.parsed.y ?? ctx.parsed)}` } }
      },
      scales: {
        x: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: '#666680', font: { family: 'DM Mono', size: 10 } }, title: { display: false } },
        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#666680', font: { family: 'DM Mono', size: 10 }, callback: v => 'R$' + v.toLocaleString('pt-BR') } }
      }
    };
  }

  // Init
  const today = new Date();
  document.getElementById('date').value = today.toISOString().split('T')[0];
  updateCategorySelect();
  // Month display will be called after login via showApp ‚Üí loadFromFirestore ‚Üí refresh
  document.getElementById('month-display').textContent =
    `${MONTHS[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

  // ‚îÄ‚îÄ‚îÄ VOICE ASSISTANT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let recognition = null;
  let isRecording = false;
  let voicePanelTimer = null;

  function toggleVoice() {
    if (isRecording) { stopVoice(); return; }
    startVoice();
  }

  function startVoice() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      showVoiceResult('error', '‚ùå Seu navegador n√£o suporta reconhecimento de voz. Use Chrome ou Edge.');
      showVoicePanel();
      return;
    }

    recognition = new SpeechRecognition();
    recognition.lang = 'pt-BR';
    recognition.interimResults = true;
    recognition.maxAlternatives = 1;

    recognition.onstart = () => {
      isRecording = true;
      document.getElementById('voice-btn').classList.add('recording');
      document.getElementById('voice-btn-label').textContent = 'Gravando‚Ä¶';
      document.getElementById('mic-icon').classList.add('recording');
      setVoiceWaveState('recording');
      document.getElementById('voice-status').textContent = 'Ouvindo‚Ä¶';
      document.getElementById('voice-transcript').textContent = 'Fale seu comando‚Ä¶';
      document.getElementById('voice-result').className = 'voice-result';
      document.getElementById('voice-result').textContent = '';
      showVoicePanel();
    };

    recognition.onresult = (e) => {
      const transcript = Array.from(e.results).map(r => r[0].transcript).join('');
      document.getElementById('voice-transcript').textContent = `"${transcript}"`;
      if (e.results[0].isFinal) {
        processVoiceCommand(transcript);
      }
    };

    recognition.onerror = (e) => {
      stopVoice();
      showVoiceResult('error', `‚ùå Erro: ${e.error === 'no-speech' ? 'Nenhuma fala detectada' : e.error}`);
    };

    recognition.onend = () => { stopVoice(); };

    recognition.start();
  }

  function stopVoice() {
    isRecording = false;
    document.getElementById('voice-btn').classList.remove('recording');
    document.getElementById('voice-btn-label').textContent = 'Comando de voz';
    document.getElementById('mic-icon').classList.remove('recording');
    if (recognition) { try { recognition.stop(); } catch(e) {} recognition = null; }
  }

  function showVoicePanel() {
    clearTimeout(voicePanelTimer);
    document.getElementById('voice-panel').classList.add('visible');
  }

  function hideVoicePanel(delay = 3500) {
    voicePanelTimer = setTimeout(() => {
      document.getElementById('voice-panel').classList.remove('visible');
    }, delay);
  }

  function setVoiceWaveState(state) {
    const wave = document.getElementById('voice-wave');
    wave.className = 'voice-wave' + (state !== 'recording' ? ' ' + state : '');
  }

  function showVoiceResult(type, message) {
    const el = document.getElementById('voice-result');
    el.className = 'voice-result ' + type;
    el.textContent = message;
    setVoiceWaveState(type);
    document.getElementById('voice-status').textContent = type === 'success' ? 'Pronto!' : 'N√£o entendi';
    hideVoicePanel();
  }

  // ‚îÄ‚îÄ‚îÄ COMMAND PARSER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function processVoiceCommand(text) {
    const t = text.toLowerCase().trim();
    setVoiceWaveState('idle');
    document.getElementById('voice-status').textContent = 'Processando‚Ä¶';

    // Determine type: income or expense
    const isIncome = /receb|ganhe|ganhei|sal√°rio|salario|renda|entrada|receita|dep√≥sito|deposito|paguei|pagaram|transfer√™ncia recebi/.test(t);
    const isExpense = /gaste|gastei|paguei|comprei|compra|despesa|sa√≠da|saida|d√©bito|debito|conta|boleto|parcela|aluguel/.test(t);

    const type = isIncome && !isExpense ? 'income' : 'expense';

    // Extract amount ‚Äî handles "50 reais", "50,00", "50.00", "cinquenta reais" etc
    const numberWords = {
      'zero':0,'um':1,'uma':1,'dois':2,'duas':2,'tr√™s':3,'tres':3,'quatro':4,
      'cinco':5,'seis':6,'sete':7,'oito':8,'nove':9,'dez':10,'onze':11,
      'doze':12,'treze':13,'quatorze':14,'quinze':15,'dezesseis':16,
      'dezessete':17,'dezoito':18,'dezenove':19,'vinte':20,'trinta':30,
      'quarenta':40,'cinquenta':50,'sessenta':60,'setenta':70,'oitenta':80,
      'noventa':90,'cem':100,'cento':100,'duzentos':200,'trezentos':300,
      'quatrocentos':400,'quinhentos':500,'seiscentos':600,'setecentos':700,
      'oitocentos':800,'novecentos':900,'mil':1000
    };

    let amount = null;

    // Try numeric patterns first
    const numMatch = t.match(/(\d+[\.,]?\d*)\s*(reais|real|conto|contos|pila)?/);
    if (numMatch) {
      amount = parseFloat(numMatch[1].replace(',', '.'));
    }

    // Try word numbers if no numeric found
    if (!amount) {
      for (const [word, val] of Object.entries(numberWords)) {
        if (t.includes(word)) { amount = val; break; }
      }
    }

    if (!amount || amount <= 0) {
      showVoiceResult('error', '‚ùå N√£o consegui identificar o valor. Tente: "gastei 50 reais no almo√ßo"');
      return;
    }

    // Detect category by keywords
    const catMap = [
      { cat: 'alimentacao', icon: 'üçΩÔ∏è', name: 'Alimenta√ß√£o', keys: ['almo√ßo','almoco','jantar','caf√©','cafe','lanche','restaurante','comida','refei√ß√£o','ifood','iFood','delivery','mercado','supermercado','feira','padaria'] },
      { cat: 'transporte',  icon: 'üöó', name: 'Transporte',  keys: ['uber','99','t√°xi','taxi','combust√≠vel','combustivel','gasolina','√¥nibus','onibus','metr√¥','metro','passagem','estacionamento','ped√°gio','pedagio'] },
      { cat: 'moradia',     icon: 'üè†', name: 'Moradia',     keys: ['aluguel','condom√≠nio','condominio','√°gua','agua','luz','energia','internet','g√°s','gas','iptu'] },
      { cat: 'saude',       icon: 'üè•', name: 'Sa√∫de',       keys: ['m√©dico','medico','farm√°cia','farmacia','rem√©dio','remedio','consulta','exame','dentista','plano de sa√∫de','academia'] },
      { cat: 'lazer',       icon: 'üé¨', name: 'Lazer',       keys: ['cinema','netflix','spotify','show','teatro','viagem','hotel','bar','balada','festa','jogo','game'] },
      { cat: 'educacao',    icon: 'üìö', name: 'Educa√ß√£o',    keys: ['curso','escola','faculdade','livro','mensalidade','ingl√™s','ingles','aula'] },
      { cat: 'compras',     icon: 'üõçÔ∏è', name: 'Compras',    keys: ['roupa','sapato','eletr√¥nico','eletronico','celular','notebook','shopping','loja','amazon','magalu'] },
      { cat: 'salario',     icon: 'üíº', name: 'Sal√°rio',     keys: ['sal√°rio','salario','pagamento','holerite'] },
      { cat: 'freelance',   icon: 'üíª', name: 'Freelance',   keys: ['freelance','freela','projeto','cliente','servi√ßo','servico'] },
      { cat: 'investimento',icon: 'üìà', name: 'Investimento',keys: ['investimento','dividendo','rendimento','a√ß√£o','acao','fundo','tesouro','renda fixa'] },
    ];

    let detectedCat = type === 'income' ? { cat: 'outros_r', icon: 'üí∞', name: 'Outros' } : { cat: 'outros_d', icon: 'üì¶', name: 'Outros' };
    for (const c of catMap) {
      if (c.keys.some(k => t.includes(k))) { detectedCat = c; break; }
    }

    // Extract description ‚Äî remove amount and type keywords, clean up
    let desc = text
      .replace(/\d+[\.,]?\d*\s*(reais|real|contos?|pilas?)?/gi, '')
      .replace(/\b(gastei|gaste|paguei|comprei|compra|recebi|receb[iu]|ganhe[i]?|ganhei|sal√°rio|salario|de|no|na|um|uma|do|da|pro|pra|com|por|em|reais|real)\b/gi, '')
      .replace(/\s+/g, ' ').trim();

    if (!desc || desc.length < 2) desc = detectedCat.name;
    desc = desc.charAt(0).toUpperCase() + desc.slice(1);

    // Build and save transaction
    const dateStr = new Date().toISOString().split('T')[0];
    const transaction = {
      id: Date.now(),
      type,
      subtype: type === 'expense' ? 'variable' : null,
      isCredit: false,
      installments: null,
      cardName: null,
      totalAmount: null,
      amount,
      category: detectedCat.cat,
      date: dateStr,
      desc
    };

    transactions.unshift(transaction);
    save();
    refresh();

    const typeLabel = type === 'income' ? 'üìà Receita' : 'üìâ Despesa vari√°vel';
    showVoiceResult('success',
      `‚úÖ Adicionado!\n${typeLabel} ¬∑ ${detectedCat.icon} ${detectedCat.name}\n"${desc}" ‚Äî ${fmt(amount)}`
    );
  }
</script>
</body>
</html>
